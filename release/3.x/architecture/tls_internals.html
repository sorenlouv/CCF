<!doctype html>
<html class="no-js" lang="en" data-content_root="">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />
<link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="TCP Internals" href="tcp_internals.html" /><link rel="prev" title="Receipts" href="receipts.html" />

    <link rel="shortcut icon" href="../_static/favicon.ico"/><!-- Generated with Sphinx 7.1.2 and Furo 2024.01.29 -->
        <title>TLS Internals - CCF documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?v=135e06be" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/tabs.css?v=4c969af8" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css?v=2a6c4383" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-bootstrap.5fd3999ee7762ccc51105388f4a9d115.css?v=45cf7dbc" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css?v=d290406d" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?v=36a5483c" />
    <link rel="stylesheet" type="text/css" href="../_static/css/custom.css?v=a4d5b81e" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #3f3f3f;
  --color-code-foreground: #dcdccc;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #3f3f3f;
  --color-code-foreground: #dcdccc;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">CCF  documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo only-light" src="../_static/ccf.svg" alt="Light Logo"/>
    <img class="sidebar-logo only-dark" src="../_static/ccf.svg" alt="Dark Logo"/>
  </div>
  
</a>

<script>
  function onVersionChange() {
    window.location.href = document.getElementById("versions").value;
  }

  window.addEventListener("DOMContentLoaded", function(){
      let selectedVersion = "main";
      const thisURL = window.location.toString();
      const splitUrl = thisURL.split("/");
      const indexOfRelease = splitUrl.indexOf("release");
      if (indexOfRelease > 0) {
        selectedVersion = splitUrl[indexOfRelease + 1];
      }
      let sel = document.getElementById("versions");
      if (sel != null) {
          let opts = sel.options;
          for (var opt, j = 0; opt = opts[j]; j++) {
              if (opt.text == selectedVersion) {
                  sel.selectedIndex = j;
                  break;
              }
          }
      }
  }, false);
</script>


<label for="versions">
  <div class="visually-hidden">Select Version:</div>
</label>
<select name="versions" id="versions" class="custom-select custom-select-sm" style="margin: 0em 1em;" onchange="onVersionChange()">
    <option value="../../../main/architecture/tls_internals.html">
      
        main
      
    </option>
    <option value="tls_internals.html">
      
        3.x
      
    </option>
    <option value="../../4.x/architecture/tls_internals.html">
      
        4.x
      
    </option>
</select>
<form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1 has-children"><a class="reference internal" href="../overview/index.html">Overview</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Overview</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../overview/what_is_ccf.html">What is CCF?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../overview/governance.html">Governance</a></li>
<li class="toctree-l2"><a class="reference internal" href="../overview/performance.html">Performance</a></li>
<li class="toctree-l2"><a class="reference internal" href="../overview/faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../overview/glossary.html">Glossary</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../build_apps/index.html">Build Apps</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Build Apps</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../build_apps/install_bin.html">Install CCF</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../build_apps/example.html">C++ Application</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of C++ Application</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../build_apps/example_cpp.html">Example app (C++)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../build_apps/example_rpc_api.html">Example app RPC API</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../build_apps/js_app_ts.html">TypeScript Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="../build_apps/js_app_bundle.html">JavaScript Application Bundle</a></li>
<li class="toctree-l2"><a class="reference internal" href="../build_apps/logging.html">Logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../build_apps/build_app.html">Build and Sign CCF Applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../build_apps/run_app.html">Running CCF Applications</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../build_apps/auth/index.html">User Authentication</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of User Authentication</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../build_apps/auth/jwt.html">JWT Authentication</a></li>
<li class="toctree-l3"><a class="reference internal" href="../build_apps/auth/cert.html">Certificate Authentication</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../build_apps/kv/index.html">Key-Value Store</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle navigation of Key-Value Store</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../build_apps/kv/kv_how_to.html">Key-Value Store How-To</a></li>
<li class="toctree-l3"><a class="reference internal" href="../build_apps/kv/kv_serialisation.html">Key-Value Serialisation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../build_apps/kv/api.html">Key-Value Store API</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../build_apps/api.html">Developer API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../build_apps/crypto.html">Cryptography API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../build_apps/release_policy.html">Release and compatibility policy</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../use_apps/index.html">Use Apps</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle navigation of Use Apps</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../use_apps/issue_commands.html">Issuing Commands</a></li>
<li class="toctree-l2"><a class="reference internal" href="../use_apps/verify_tx.html">Verifying Transactions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../use_apps/verify_quote.html">Verifying Quote</a></li>
<li class="toctree-l2"><a class="reference internal" href="../use_apps/rpc_api.html">RPC API</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../operations/index.html">Operations</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><div class="visually-hidden">Toggle navigation of Operations</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../operations/run_setup.html">Setup CCF Runtime Environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../operations/start_network.html">Running a CCF Service</a></li>
<li class="toctree-l2"><a class="reference internal" href="../operations/configuration.html">Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../operations/ledger_snapshot.html">Ledger and Snapshots</a></li>
<li class="toctree-l2"><a class="reference internal" href="../operations/code_upgrade.html">Code Upgrade</a></li>
<li class="toctree-l2"><a class="reference internal" href="../operations/certificates.html">Certificates</a></li>
<li class="toctree-l2"><a class="reference internal" href="../operations/recovery.html">Disaster Recovery</a></li>
<li class="toctree-l2"><a class="reference internal" href="../operations/data_persistence.html">Data Persistence</a></li>
<li class="toctree-l2"><a class="reference internal" href="../operations/network.html">Networking</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../operations/platforms/index.html">Platforms</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" role="switch" type="checkbox"/><label for="toctree-checkbox-8"><div class="visually-hidden">Toggle navigation of Platforms</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../operations/platforms/sgx.html">Intel SGX</a></li>
<li class="toctree-l3"><a class="reference internal" href="../operations/platforms/snp.html">AMD SEV-SNP</a></li>
<li class="toctree-l3"><a class="reference internal" href="../operations/platforms/virtual.html">Insecure Virtual</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../operations/troubleshooting.html">Troubleshooting CCF</a></li>
<li class="toctree-l2"><a class="reference internal" href="../operations/resource_usage.html">Resource Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../operations/operator_rpc_api.html">Operator RPC API</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../governance/index.html">Governance</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" role="switch" type="checkbox"/><label for="toctree-checkbox-9"><div class="visually-hidden">Toggle navigation of Governance</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../governance/constitution.html">Constitution</a></li>
<li class="toctree-l2"><a class="reference internal" href="../governance/proposals.html">Proposing and Voting for a Proposal</a></li>
<li class="toctree-l2"><a class="reference internal" href="../governance/js_runtime.html">JavaScript Runtime Options</a></li>
<li class="toctree-l2"><a class="reference internal" href="../governance/open_network.html">Opening a Network</a></li>
<li class="toctree-l2"><a class="reference internal" href="../governance/accept_recovery.html">Accepting Recovery and Submitting Shares</a></li>
<li class="toctree-l2"><a class="reference internal" href="../governance/common_member_operations.html">Common Governance Operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../governance/adding_member.html">Adding New Members</a></li>
<li class="toctree-l2"><a class="reference internal" href="../governance/hsm_keys.html">Using Member Keys Stored in HSM</a></li>
<li class="toctree-l2"><a class="reference internal" href="../governance/member_rpc_api.html">Member RPC API</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../audit/index.html">Audit</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" role="switch" type="checkbox"/><label for="toctree-checkbox-10"><div class="visually-hidden">Toggle navigation of Audit</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../audit/receipts.html">Receipts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../audit/builtin_maps.html">Built-in Maps</a></li>
<li class="toctree-l2"><a class="reference internal" href="../audit/python_library.html">Python Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="../audit/read_write_restrictions.html">Read-Write Permissions On KV Maps</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../contribute/index.html">Contribute</a><input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" role="switch" type="checkbox"/><label for="toctree-checkbox-11"><div class="visually-hidden">Toggle navigation of Contribute</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../contribute/onboarding.html">Onboarding</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contribute/create_vm.html">Create Azure SGX VM</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contribute/build_setup.html">CCF Development Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contribute/build_ccf.html">Build CCF from Source</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contribute/release_ccf.html">Release or patch a CCF release</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contribute/build_images.html">CCF Build Images</a></li>
</ul>
</li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="index.html">Architecture</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" role="switch" type="checkbox"/><label for="toctree-checkbox-12"><div class="visually-hidden">Toggle navigation of Architecture</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2 has-children"><a class="reference internal" href="consensus/index.html">Consensus Protocols</a><input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" role="switch" type="checkbox"/><label for="toctree-checkbox-13"><div class="visually-hidden">Toggle navigation of Consensus Protocols</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="consensus/1tx-reconfig.html">One-transaction Reconfiguration</a></li>
<li class="toctree-l3"><a class="reference internal" href="consensus/2tx-reconfig.html">Two-transaction Reconfiguration</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="cryptography.html">Cryptography</a></li>
<li class="toctree-l2"><a class="reference internal" href="request_flow.html">Request Flow</a></li>
<li class="toctree-l2"><a class="reference internal" href="threading.html">Threading</a></li>
<li class="toctree-l2"><a class="reference internal" href="merkle_tree.html">Merkle Tree</a></li>
<li class="toctree-l2"><a class="reference internal" href="ledger.html">Ledger</a></li>
<li class="toctree-l2"><a class="reference internal" href="raft_tla.html">TLA+ Specification</a></li>
<li class="toctree-l2"><a class="reference internal" href="node_to_node.html">Node-to-Node Channels</a></li>
<li class="toctree-l2"><a class="reference internal" href="indexing.html">Indexing</a></li>
<li class="toctree-l2"><a class="reference internal" href="receipts.html">Receipts</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">TLS Internals</a></li>
<li class="toctree-l2"><a class="reference internal" href="tcp_internals.html">TCP Internals</a></li>
<li class="toctree-l2"><a class="reference internal" href="quic_internals.html">QUIC Internals</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../research/index.html">Research</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="tls-internals">
<h1>TLS Internals<a class="headerlink" href="#tls-internals" title="Permalink to this heading">#</a></h1>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this heading">#</a></h2>
<p>In CCF, the <a class="reference internal" href="../overview/glossary.html#term-TLS"><span class="xref std std-term">TLS</span></a> layer is implemented using OpenSSL 1.1.1 from <a class="reference internal" href="../overview/glossary.html#term-Open-Enclave"><span class="xref std std-term">Open Enclave</span></a> (OE). However, the original implementation was using OE’s MbedTLS library, which the current implementation replaced. During the transition period, the OpenSSL implementation had to emulate the previous MbedTLS one and the remaining code isn’t particularly suited to OpenSSL.</p>
<p>In addition, we’ll soon be adding <a class="reference internal" href="../overview/glossary.html#term-QUIC"><span class="xref std std-term">QUIC</span></a> support to CCF, which has its own usage of TLS (supporting OpenSSL, but from its own tree).</p>
<p>This document is an attempt to describe how that works, so that we can plan a suited implementation for both TCP-based and QUIC-based endpoints using TLS.</p>
</section>
<section id="enclave-connections">
<h2>Enclave Connections<a class="headerlink" href="#enclave-connections" title="Permalink to this heading">#</a></h2>
<p>CCF handles RPC requests by managing a collection of HTTPS sessions on each node. The HTTP session receives raw TCP bytes from the <a class="reference internal" href="../overview/glossary.html#term-Ring-Buffer"><span class="xref std std-term">ring buffer</span></a> and passes it to the TLS implementation that tries to decrypt on read (after a successful handshake).</p>
<p>If there isn’t enough information to decrypt on read, the TLS layer responds with a ‘WANTS_READ’ message, meaning more packets are needed to complete the message, so the endpoint tried to get more data from the ring buffer.</p>
<p>Once all incoming data is decrypted, the HTTP session parses the plain text data and passes the parsed request to the application, which process it and produces a plain text response. The session then serialises this response, encrypts it through the TLS layer, and writes the encrypted data to the <a class="reference internal" href="../overview/glossary.html#term-Ring-Buffer"><span class="xref std std-term">ring buffer</span></a> to be sent to the original caller.</p>
</section>
<section id="tls-implementation">
<h2>TLS Implementation<a class="headerlink" href="#tls-implementation" title="Permalink to this heading">#</a></h2>
<p>The TLS implementation in ‘src/tls’ has three main components:</p>
<ul class="simple">
<li><p>A ‘Certificate Authority’ (CA), which has a root certificate that can sign other certificates in the network. This CA certificate is generated by the network outside of the TLS implementation and is imported when clients and servers are created.</p></li>
<li><p>A ‘Certificate’ (Cert), which is the server/client’s own certificate, signed by the CA and unique to this server or client.</p></li>
<li><p>A ‘Context’, which is the common implementation of both ‘Client’ and ‘Server’ and provides input (read and decrypt) and output (encrypt and write) over the ring buffer and its triggers. Clients and servers are basically just a Context with a certificate.</p></li>
</ul>
<p>Both CA and Cert have internal logic to validate their certificates and private keys, and the Context has logic to complete a TLS handshake, read and write using encryption and to query the peer’s certificate.</p>
<p>The next layer up is the ‘TLSSession’ (of which ‘HTTPSession’ owns an instance) that holds the ring buffer, the pending read and write buffers, and the call backs for sending and receiving data.</p>
</section>
<section id="receiving-messages">
<h2>Receiving Messages<a class="headerlink" href="#receiving-messages" title="Permalink to this heading">#</a></h2>
<p>When a REST node message is received through the ring buffer, the ‘HTTPSession’ <code class="docutils literal notranslate"><span class="pre">recv_()</span></code> method is called (as it was registered as a callback). That calls <code class="docutils literal notranslate"><span class="pre">TLSSession::read()</span></code> which in turn calls <code class="docutils literal notranslate"><span class="pre">tls::Context::read()</span></code>.</p>
<p>However, when creating the TLS ‘Context’, the ‘TLSSession’ had to register some callbacks of its own, too. This is one of the parts that was specific to MbedTLS and that was (unnaturally) replicated to OpenSSL.</p>
<p>Those callbacks are implemented in ‘TLSSession’ because they need access to the <code class="docutils literal notranslate"><span class="pre">pending_read</span></code> buffers to read from and the ‘ring buffer’ to write to.  But the TLS context (‘SSL’ and ‘SSL_CTX’ objects) need to encrypt/decrypt data, and they can only do that from ‘BIO’s in OpenSSL, so the callback has a mix of ring buffer and BIO handling that tricks both sides to take the appropriate steps at the right time in this complex dance.</p>
<p>In the ‘read’ case, the message has arrived into the <code class="docutils literal notranslate"><span class="pre">pending_read</span></code> buffer via a (previously triggered) ring buffer callback, and that data is written to TLS’s ‘read’ BIO (via <code class="docutils literal notranslate"><span class="pre">BIO_write_ex</span></code>) _before_ TLS itself reads it.  That data is still encrypted, so when the TLS reads it with <code class="docutils literal notranslate"><span class="pre">SSL_read_ex</span></code>, it tries to decrypt and on success, returns a plain text buffer. On error, it emits the error or a ‘WANTS_READ’ status, so the endpoint can try to extract more information from the <code class="docutils literal notranslate"><span class="pre">pending_read</span></code> buffer again.</p>
<p>Upon success, the read BIO is flushed and new data can be read again. The plain text result is returned all the way back to <code class="docutils literal notranslate"><span class="pre">HTTPSession::recv_()</span></code> that then sends it to the application to process.</p>
</section>
<section id="sending-messages">
<h2>Sending Messages<a class="headerlink" href="#sending-messages" title="Permalink to this heading">#</a></h2>
<p>When the application finishes, it returns a plain text response. That message is sent back to the client via the <code class="docutils literal notranslate"><span class="pre">send()</span></code> call. This in turn calls <code class="docutils literal notranslate"><span class="pre">TLSSession::send_raw()</span></code> that via a series of asynchronous dispatches ends up filling the <code class="docutils literal notranslate"><span class="pre">pending_write</span></code> buffer and calling <code class="docutils literal notranslate"><span class="pre">write_some()</span></code> which itself calls <code class="docutils literal notranslate"><span class="pre">tls::Context::write()</span></code>.</p>
<p>This is the same process as for reads: a callback in ‘TLSSession’ was registered for the ‘write’ BIO, with access to the <code class="docutils literal notranslate"><span class="pre">pending_write</span></code> and the ring buffer. But in this case, the callback is only executed _after_ the TLS layer has encrypted the data and written to the ‘write’ BIO.</p>
<p>Now, we take that (encrypted) data, flush the BIO ourselves (to avoid clogging the pipes with the next message) and send it through the ring buffer with the <code class="docutils literal notranslate"><span class="pre">RINGBUFFER_TRY_WRITE_MESSAGE(tls_outbound,...)</span></code> macro.</p>
<p>This is what actually sends the message back to the client, so when this callback returns, the remaining stack just returns the status of that write.  Different errors are treated at different levels (TLS errors in Context, ring buffer errors in TLSSession and HTTP errors in HTTPSession).</p>
</section>
<section id="why-openssl">
<h2>Why OpenSSL?<a class="headerlink" href="#why-openssl" title="Permalink to this heading">#</a></h2>
<p>The main reasons why we moved to OpenSSL are:</p>
<ul class="simple">
<li><p>We already use OpenSSL for our crypto library (‘src/crypto’).</p></li>
<li><p>We wanted TLS 1.3 support and MbedTLS doesn’t have it.</p></li>
<li><p>We want to support QUIC, that doesn’t work with MbedTLS.</p></li>
</ul>
<p>By now we have removed any traces of MbedTLS, but we are still using OE’s OpenSSL library, which doesn’t have QUIC support.</p>
<p>To implement the last point above, we need to build QUIC with its own OpenSSL and use that as our library for the remaining crypto, but OE has its own modifications to OpenSSL as well, and we can’t have both.</p>
<p>So, for now, the only way to have QUIC support is in ‘virtual’ mode, retaining OE’s OpenSSL for ‘sgx’ mode. Once we have other types of enclaves that don’t require Open Enclave we can use QUIC’s version, too.</p>
</section>
<section id="mbedtls-vs-openssl">
<h2>MbedTLS vs OpenSSL<a class="headerlink" href="#mbedtls-vs-openssl" title="Permalink to this heading">#</a></h2>
<p>As stated above, the current OpenSSL implementation is _emulating_ the previous MbedTLS one, so some oddities are observed.</p>
<p>First, MbedTLS returns errors as negative values and amount of data handled as positive values. OpenSSL concurs on positive values but returns 0 (or -1 in previous versions) for all errors, using <code class="docutils literal notranslate"><span class="pre">SSL_get_error</span></code> to then classify which error and what to do. The error values are also positive.</p>
<p>To simulate this, we implement the error handling at each invocation and, on error, we negate the value of the error so that we can retain the old behavior of checking for negative values.</p>
<p>Second, MbedTLS keeps all its context (configuration, connection info, read and write buffers) in a single large structure, while OpenSSL has separate structures for each and uses ‘BIO’ objects for buffers. Reads and writes in MbedTLS is done exclusively via callbacks.</p>
<p>OpenSSL callbacks, however, are very different from MbedTLS ones. They are called twice for each action, one before the actual action and another after.</p>
<p>To simulate this we had to implement a read callback _before_ the BIO read (so we could fill it up with the contents of the ring buffer) and the write callback _after_ the BIO write (so we could pick up its contents and send it into the ring buffer).</p>
<p>There is a complex dance of return values in OpenSSL’s callbacks. If any returns errors the action is canceled immediately. On reads, because the BIO was empty, the initial return value is an error, so we must make sure that, if there is anything in the <code class="docutils literal notranslate"><span class="pre">pending_read</span></code> buffer, we have to change the status to the amount of bytes read, so it can continue.</p>
<p>Third, the handshake in MbedTLS had various types of errors, which we had to emulate by making the appropriate <code class="docutils literal notranslate"><span class="pre">SSL_*</span></code> calls, check the peer certificate, etc. to get the same types of responses for the same situations.</p>
<p>Finally, in MbedTLS, the configuration and session objects were setup at the same time, while in OpenSSL they’re separate. We ended up duplicating every single configuration, but this is unnecessary, because once the config object is correct, any session object created from it has the same properties.</p>
<p>But the TLS Context doesn’t handle more than one session per configuration, so we could set either of them once and ignore the other. The simplest thing would be to setup just the session, but if we end up having more than one session later, we’d have to refactor that.</p>
</section>
<section id="pure-openssl-implementation">
<h2>Pure OpenSSL Implementation<a class="headerlink" href="#pure-openssl-implementation" title="Permalink to this heading">#</a></h2>
<p>With MbedTLS gone from the code base, we can now think of a pure OpenSSL implementation.</p>
<p>The considerations are:</p>
<ul class="simple">
<li><p>We don’t need to handle errors inside the calls to read/write, but can leave for each caller to handle IFF there is an error by calling <code class="docutils literal notranslate"><span class="pre">SSL_get_error</span></code>.  This also means we don’t need to negate error values, as they’re in different domains.</p></li>
<li><p>We can simplify the SSL configuration on startup, handshake handling and peer certificate handling.</p></li>
</ul>
<p>However, getting rid of the callbacks and using BIOs directly is going to be hard.</p>
<p>First, the current callback is in ‘TLSSession’ because it has access to both pending buffers and the ring buffer. The TLS Context does not have access to it nor it would be wise to pass references to it, as that’d make the Context exclusive to the TLSSession.</p>
<p>Second, both endpoint and TLS have a need to read and write asynchronously. Data arrives from the ring buffer at any time and the TLS implementation can request reads and writes (for example, during handshake) that the endpoint didn’t request itself.</p>
<p>So if <code class="docutils literal notranslate"><span class="pre">SSL_handshake</span></code>, <code class="docutils literal notranslate"><span class="pre">SSL_read_ex</span></code> and <code class="docutils literal notranslate"><span class="pre">SSL_write_ex</span></code> don’t have direct access to read and write from the ring buffers without direct requests from the endpoints, it won’t be able to conclude the asynchronous handshake and start the connection.</p>
<p>One possible way out of it is to create a <a class="reference external" href="https://www.openssl.org/docs/man1.1.1/man3/BIO_s_bio.html">BIO pair</a> for each read/write action between the ‘TLSSession’ and the TLS ‘Context’, driven by two asynchronous tasks in ‘TLSSession’ that just poll the BIOs and buffers and pass data across. This removes a callback, but introduces polling, which is not an actual improvement.</p>
</section>
</section>

        </article>
      </div>
      <footer>
        
  
        <div class="related-pages">
          <a class="next-page" href="tcp_internals.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">TCP Internals</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="receipts.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Receipts</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2018, Microsoft Research
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
  <script>
    // Edit this page, on GitHub
    var contentIconContainer = document.querySelector(".content-icon-container");
    const editContent = `
    <div class="edit-this-page">
      <a class="muted-link" href="https://github.com/Microsoft/CCF/edit/main/doc/architecture/tls_internals.rst">
        <svg viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
          <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
          <path d="M4 20h4l10.5 -10.5a1.5 1.5 0 0 0 -4 -4l-10.5 10.5v4" />
          <line x1="13.5" y1="6.5" x2="17.5" y2="10.5" />
        </svg>
      </a>
    </div>`;
    contentIconContainer.insertAdjacentHTML("afterbegin", editContent);

    // Show GitHub repository home
    var icons = document.querySelector(".icons")
    const repoLinkContent = `
    <a class="muted-link" href="https://github.com/Microsoft/CCF" aria-label="On GitHub">
      <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16">
        <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path>
      </svg>
    </a>`;
    icons.insertAdjacentHTML("beforeend", repoLinkContent);
  </script>

      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">TLS Internals</a><ul>
<li><a class="reference internal" href="#overview">Overview</a></li>
<li><a class="reference internal" href="#enclave-connections">Enclave Connections</a></li>
<li><a class="reference internal" href="#tls-implementation">TLS Implementation</a></li>
<li><a class="reference internal" href="#receiving-messages">Receiving Messages</a></li>
<li><a class="reference internal" href="#sending-messages">Sending Messages</a></li>
<li><a class="reference internal" href="#why-openssl">Why OpenSSL?</a></li>
<li><a class="reference internal" href="#mbedtls-vs-openssl">MbedTLS vs OpenSSL</a></li>
<li><a class="reference internal" href="#pure-openssl-implementation">Pure OpenSSL Implementation</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js?v=b3ba4146"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../_static/scripts/furo.js?v=32e29ea5"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/tabs.js?v=3ee01567"></script>
    <script src="https://kit.fontawesome.com/c75a35380d.js"></script>
    </body>
</html>